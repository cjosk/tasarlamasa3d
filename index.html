<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Masa Konfigüratörü | Spatial Glass Edition</title>
    
    <!-- Tailwind CSS ve Inter Font Yükleniyor -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Apple Dark Mode / Glassmorphism için temiz renk paleti
                        'primary-apple': '#007AFF', // iOS/macOS Blue
                        'dark-bg': '#0D1117', // Ultra Koyu Arka Plan
                        'glass-surface': 'rgba(255, 255, 255, 0.05)', // Modül içi hafif beyaz parlama
                        'glass-bg': 'rgba(10, 25, 40, 0.35)', // Derin, koyu şeffaf ana kart
                        'glass-border': 'rgba(255, 255, 255, 0.1)', // İnce, zarif beyaz sınır
                        'neon-accent': '#3B82F6', // Neon Mavi aksan (macOS Mavi Tonu)
                    },
                    fontFamily: {
                        // Apple'ın San Francisco fontuna yakın bir his için Inter
                        sans: ['Inter', 'sans-serif'], 
                    },
                    boxShadow: {
                        // Daha derin ve yumuşak gölgeler
                        'glass-deep': '0 8px 32px 0 rgba(0, 0, 0, 0.37)', 
                        'glow-blue': '0 0 15px rgba(59, 130, 246, 0.5)',
                    }
                }
            }
        }
    </script>
    
    <!-- Three.js ve OrbitControls Yükleniyor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <!-- Firebase Modülleri Yükleniyor -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global değişkenleri tanımlama
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.collection = collection;
        window.query = query;
        window.onSnapshot = onSnapshot;
        window.getDocs = getDocs;
        window.setLogLevel = setLogLevel;
    </script>
    
    <style>
        /* Ana Tema Stilleri */
        body {
            overflow: hidden;
            background-color: #0D1117; /* Ultra Koyu */
        }
        #scene-container {
            flex-grow: 1;
        }
        canvas {
            display: block;
        }
        
        /* Glassmorphism Uygulaması */
        .ui-card {
            background-color: var(--tw-color-glass-bg); /* Koyu şeffaf arkaplan */
            backdrop-filter: blur(24px) saturate(180%); /* Güçlü buzlu cam efekti */
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid var(--tw-color-glass-border); /* İnce beyaz sınır */
            border-radius: 20px; /* Daha yuvarlak, modern */
            color: #E5E7EB; 
            box-shadow: var(--tw-box-shadow-glass-deep); /* Derin gölge */
            min-width: 300px; /* Sabit minimum genişlik */
        }
        .glass-module {
            background-color: rgba(10, 25, 40, 0.6); /* Modül içi biraz daha opak */
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 14px;
        }
        
        /* Neon Renk Seçici Stilizasyonu */
        .neon-color-button {
            width: 36px;
            height: 36px;
            border: 3px solid transparent;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            outline: none;
        }
        .neon-color-button.selected {
            border-color: #FFFFFF;
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.9), 0 0 8px currentColor; /* Renk parlaması */
        }

        /* Ebat Seçim Butonları */
        .size-button {
            @apply w-full block bg-glass-surface hover:bg-glass-surface/50 text-white font-medium py-3 px-4 rounded-xl cursor-pointer transition duration-200 shadow-md border border-glass-border/50;
        }
        .size-button.selected {
            @apply bg-neon-accent/80 text-white font-semibold shadow-glow-blue border-neon-accent/50 transform scale-[1.01];
        }

        /* Responsive Kontrol Paneli (Apple UI Hissiyatı) */
        @media (max-width: 1024px) {
            main {
                flex-direction: column-reverse; /* Kontrolleri alta al */
            }
            #controls-wrapper {
                width: 100%;
                max-height: 60vh; /* Mobil cihazlarda daha fazla kontrol alanı */
                border-radius: 20px 20px 0 0;
            }
            #scene-container {
                height: 40vh; /* Sahneye biraz daha az yer */
            }
        }
        
        /* Scrollbar İyileştirmesi (Apple Tarzı İnce Çubuk) */
        #controls-scroll-area {
            /* Scrollbar her zaman görünür olacak şekilde ayarlandı */
            overflow-y: scroll; 
            scrollbar-width: thin;
            scrollbar-color: #4B5563 #0D1117;
        }
        #controls-scroll-area::-webkit-scrollbar {
            width: 6px;
        }
        #controls-scroll-area::-webkit-scrollbar-thumb {
            background-color: #4B5563;
            border-radius: 3px;
        }
        #controls-scroll-area::-webkit-scrollbar-track {
            background: transparent;
        }
    </style>
</head>
<body class="font-sans">

    <!-- Ana Konteyner -->
    <div class="h-screen flex flex-col">
        <!-- Başlık (Minimalist Başlık Çubuğu - Dock Hissi) -->
        <header class="p-3 shadow-2xl flex justify-between items-center text-white sticky top-0 z-20 h-16 bg-dark-bg/80 backdrop-blur-md">
            <div class="flex items-center">
                <img src="https://neonbirr.com/cdn/shop/files/cropped-cropped-Yeni-Proje-24.webp?v=1696324634&width=90" alt="Neon Masa Logo" class="h-8 mr-4 rounded-lg shadow-xl">
                <!-- Kullanıcı isteği üzerine başlık metni kaldırıldı -->
            </div>
            <div id="user-info" class="text-xs px-4 py-2 rounded-full bg-glass-surface border border-glass-border/70 transform transition-transform duration-200 hover:scale-[1.02]">
                <span class="text-gray-400">Kullanıcı ID:</span> <span id="user-id-display" class="font-mono text-neon-accent font-medium">Yükleniyor...</span>
            </div>
        </header>

        <!-- Ana İçerik ve Kontroller -->
        <main class="flex-grow flex">

            <!-- Kontrol Paneli (Sol Kenar Çubuğu - Glassmorphism Kart) -->
            <!-- Genişlik: Desktop'ta 380px, mobil cihazlarda tam genişlik. -->
            <div id="controls-wrapper" class="w-full lg:w-[380px] max-w-lg p-4 lg:p-6 ui-card flex flex-col z-10">
                
                <h2 class="text-2xl font-semibold mb-4 text-white">Tasarım Kontrolleri</h2>
                
                <!-- Kaydırılabilir Alan -->
                <div id="controls-scroll-area" class="flex-grow overflow-y-auto pr-2 space-y-6 pb-6">
                    
                    <!-- 1. Ebat Seçimi Modülü (Butonlu hale getirildi) -->
                    <div class="glass-module p-4 rounded-xl shadow-xl space-y-4">
                        <label class="block text-lg font-bold text-neon-accent">1. Masa Ebatını Seçin</label>
                        <div id="size-selector" class="space-y-3">
                            <!-- Boyut Butonları JS ile Eklenecek -->
                        </div>
                    </div>

                    <!-- 2. Renk Seçimi Modülü -->
                    <div class="glass-module p-4 rounded-xl shadow-xl">
                        <label class="block text-lg font-bold text-neon-accent">2. Neon Rengi Seçin</label>
                        <div id="color-picker" class="flex gap-4 p-2 flex-wrap justify-start">
                            <!-- Renk Butonları Buraya JS ile Eklenecek -->
                        </div>
                    </div>
                    
                    <!-- 3. Şekil Kütüphanesi Modülü -->
                    <div class="space-y-3">
                        <button id="toggle-shapes" class="w-full bg-primary-apple/80 hover:bg-primary-apple text-white font-bold py-3 px-4 rounded-xl transition duration-200 flex justify-between items-center shadow-lg transform hover:scale-[1.01]">
                            <span class="text-lg">3. Şekil Ekle / Kütüphanesi</span>
                            <svg id="shapes-arrow" class="w-5 h-5 transform transition-transform duration-300 rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        
                        <!-- Şekil Kütüphanesi İçeriği -->
                        <div id="shape-library" class="hidden p-4 glass-module rounded-xl shadow-xl">
                            <button id="add-straight-line" class="w-full bg-neon-accent hover:bg-neon-accent/90 text-white font-bold py-2 px-4 rounded-lg mb-3 transition duration-150 shadow-md">
                                Düz Neon Çubuk Ekle (40cm)
                            </button>
                            <div class="grid grid-cols-4 gap-3">
                                 <!-- Görsel Şekil Butonları -->
                                 <button id="add-zigzag-m-line" class="shape-button flex flex-col items-center justify-center p-3 glass-module rounded-lg transition duration-150 text-yellow-300 hover:bg-gray-700/50">
                                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M 10 90 L 35 10 L 60 90 L 85 10 L 90 90" />
                                    </svg>
                                    <span class="text-xs mt-1">M Şekli</span>
                                </button>
                                <button id="add-zigzag-n-line" class="shape-button flex flex-col items-center justify-center p-3 glass-module rounded-lg transition duration-150 text-cyan-300 hover:bg-gray-700/50">
                                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M 10 90 L 10 10 L 90 90 L 90 10" />
                                    </svg>
                                    <span class="text-xs mt-1">N Harfi</span>
                                </button>
                                <button id="add-v-shape-line" class="shape-button flex flex-col items-center justify-center p-3 glass-module rounded-lg transition duration-150 text-lime-300 hover:bg-gray-700/50">
                                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M 10 10 L 50 90 L 90 10" />
                                    </svg>
                                    <span class="text-xs mt-1">V Harfi</span>
                                </button>
                                <button id="add-single-peak-line" class="shape-button flex flex-col items-center justify-center p-3 glass-module rounded-lg transition duration-150 text-pink-300 hover:bg-gray-700/50">
                                    <svg class="w-8 h-8" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="8" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M 10 90 L 50 10 L 90 90" />
                                    </svg>
                                    <span class="text-xs mt-1">A Harfi</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Öğeyi Konumlandır Modülü (Seçim Yapılınca Görünür) -->
                    <div id="selected-element-info" class="glass-module p-4 rounded-xl shadow-xl border border-neon-accent/30 hidden">
                        <p class="font-bold text-lg text-neon-accent mb-3">4. Seçili Öğeyi Düzenle</p>
                        
                        <!-- X Konum Kontrolü (En) -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2 text-gray-300">X Konumunu Ayarla (En)</label>
                            <input type="range" id="control-pos-x" min="-0.4" max="0.4" step="0.01" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                        </div>
                        
                        <!-- Z Konum Kontrolü (Boy) -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2 text-gray-300">Z Konumunu Ayarla (Boy)</label>
                            <input type="range" id="control-pos-z" min="-0.2" max="0.2" step="0.01" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                        </div>

                        <!-- Y Rotasyon Kontrolü -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2 text-gray-300">Y Rotasyonu (Düzlemde)</label>
                            <input type="range" id="control-rot-y" min="0" max="360" step="5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                        </div>

                        <button id="remove-neon" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mt-3 transition duration-150 shadow-md transform hover:scale-[1.01]">
                            Seçili Öğeyi Sil
                        </button>
                    </div>
                    
                    <!-- 5. Araçlar Modülü -->
                    <div class="glass-module p-4 rounded-xl shadow-xl space-y-3">
                        <p class="font-bold text-lg text-neon-accent">Araçlar ve Görünüm</p>

                        <!-- Neon ve Yazı Sınırları (Ayrı Açıklama) -->
                        <div id="design-limits-info" class="text-xs text-gray-400 p-3 rounded-lg bg-dark-bg/50 border border-glass-border/70">
                            <!-- JS ile yüklenecek -->
                        </div>
                        
                        <button id="toggle-glass" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            Cam Kapağını Kaldır
                        </button>
                        
                        <button id="toggle-effect" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                            Efektleri Kapat (Neon Kapalı)
                        </button>
                        
                        <div class="flex space-x-3 pt-2">
                            <button id="save-design" class="w-1/2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md transform hover:scale-[1.01]">
                            Kaydet
                            </button>
                            <button id="load-design" class="w-1/2 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md transform hover:scale-[1.01]">
                                Yükle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ödeme Modülü (Artık Kaydırılabilir İçerik) -->
                    <div class="pt-6 mt-4 border-t border-glass-border/50">
                        <!-- Fiyat Gösterimi (Apple Style) -->
                        <div class="text-center mb-3 p-3 bg-glass-surface rounded-xl shadow-inner">
                            <p class="text-md font-light text-gray-300">Toplam Konfigürasyon Fiyatı:</p>
                            <p id="current-price-final" class="text-4xl font-extrabold text-white mt-1 tracking-wider">20.000 TL</p>
                        </div>

                        <!-- WhatsApp Sipariş Butonu -->
                        <button id="order-whatsapp" class="w-full bg-[#25D366] hover:bg-[#128C7E] text-white font-bold py-4 px-4 rounded-xl text-xl transition duration-150 shadow-2xl shadow-[#25D366]/50 flex items-center justify-center transform hover:scale-[1.02]">
                            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12.039 2c-5.584 0-10.126 4.542-10.126 10.126 0 1.748.44 3.421 1.284 4.887l-1.34 4.904 5.025-1.315c1.42.54 3.09 1.284 4.837 1.284h.01c5.584 0 10.126-4.542 10.126-10.126s-4.542-10.126-10.126-10.126zm0 18.42c-2.88 0-5.55-.916-7.85-2.52l-.56-.334-3.13.82.83-3.045-.357-.577c-1.64-2.483-2.5-5.32-2.5-8.26 0-4.634 3.766-8.4 8.4-8.4s8.4 3.766 8.4 8.4-3.766 8.4-8.4 8.4zm4.456-6.19c-.244-.122-.962-.477-1.11-.532-.148-.054-.256-.08-.363.08-.107.155-.417.532-.51.64-.093.107-.186.12-.34.037-.154-.08-2.618-1.615-4.997-3.084-.397-.243-.666-.41-2.843-1.745-.246-.145-.353-.2-.407-.225-.053-.027-.42-.032-.816-.032-.397 0-.962.122-1.306.61-.345.488-1.307 1.272-1.307 3.107 0 1.835 1.522 3.593 1.522 3.84 0 .002.396.488.908 1.05.512.56.962.748 1.805.975.842.227 1.73.197 2.37.133.64-.06 1.87-.76 2.14-1.503.268-.743.268-1.373.185-1.503-.082-.13-.148-.155-.303-.236z"/>
                            </svg>
                            SİPARİŞİ TAMAMLA (WhatsApp)
                        </button>
                    </div>
                </div>

                <!-- Ödeme Modülü buradaydı, artık kaydırılabilir alanın içinde -->
            </div>

            <!-- 3D Sahne Konteyneri (Değişmeyen Alan) -->
            <div id="scene-container" class="flex-grow bg-dark-bg relative">
                <div id="loading-overlay" class="absolute inset-0 bg-gray-900/90 flex items-center justify-center z-10 text-white text-xl font-light tracking-wider">
                    3D Sahne Yükleniyor...
                </div>
                <!-- 3D Canvas buraya yerleştirilecek -->
            </div>
        </main>
        
        <!-- Alt Çubuk (Profesyonel İpucu) -->
        <footer class="bg-dark-bg p-2 text-center text-xs text-gray-500 border-t border-gray-800">
            İpucu: Masayı döndürmek ve yakınlaştırmak için farenizi kullanın. Seçmek için neon çubuğa tek tıklayın.
        </footer>
    </div>

    <!-- Modallar (Glassmorphism Modal) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4">
        <div class="ui-card p-8 rounded-2xl shadow-glass-deep max-w-lg w-full text-white">
            <h3 id="modal-title" class="text-2xl font-semibold mb-4 text-neon-accent">Başlık</h3>
            <p id="modal-message" class="mb-6 text-gray-200">Mesaj içeriği.</p>
            <div class="flex justify-end space-x-2">
                <button id="modal-close" class="bg-gray-700/50 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-xl transition duration-150 border border-glass-border/70">
                    Kapat
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Global Three.js değişkenleri
        let scene, camera, renderer, controls;
        let db, auth, userId = 'anon_user';
        let neonElementsData = [];
        let selectedNeonObject = null;
        let currentSelectedColor = '#00FFFF'; // Varsayılan: Mavi
        let glassContainer = null; 
        let smokedGlassMirrorMaterial = null; 
        let isEffectOn = true; 
        const NEON_EMISSIVE_POWER_ON = 1.0;
        const NEON_EMISSIVE_POWER_OFF = 0.01; 

        const neonColors = [
            { name: "Mavi", hex: "#00FFFF" },
            { name: "Yeşil", hex: "#00FF00" },
            { name: "Kırmızı", hex: "#FF0000" },
            { name: "Pembe", hex: "#FF00FF" },
            { name: "Sarı", hex: "#FFFF00" },
            { name: "Beyaz", hex: "#FFFFFF" }
        ];

        // Masa Boyutları, Fiyatları ve Sınırları
        const tableSizes = [
            {
                name: "70x45x50 CM",
                width: 0.70,
                depth: 0.45,
                height: 0.50,
                price: 15000,
                limits: { m: 1, a: 2, v: 2, n: 2, text_cm: '60cm x 30cm' } 
            },
            {
                name: "90x45x50 CM",
                width: 0.90,
                depth: 0.45,
                height: 0.50,
                price: 20000,
                limits: { m: 1, a: 2, v: 2, n: 2, text_cm: '80cm x 30cm' }
            },
            {
                name: "120x80x50 CM",
                width: 1.20,
                depth: 0.80,
                height: 0.50,
                price: 35000,
                limits: { m: 2, a: 4, v: 4, n: 4, text_cm: '110cm x 30cm' }
            },
            {
                name: "150x80x50 CM",
                width: 1.50,
                depth: 0.80,
                height: 0.50,
                price: 45000,
                limits: { m: 3, a: 6, v: 6, n: 6, text_cm: '140cm x 30cm' }
            }
        ];

        // Sabitler (Mevcut seçime göre dinamik olacak)
        let currentSizeIndex = 1; 
        let TABLE_WIDTH = tableSizes[currentSizeIndex].width; 
        let TABLE_DEPTH = tableSizes[currentSizeIndex].depth; 
        let TABLE_FRAME_HEIGHT = tableSizes[currentSizeIndex].height; 
        
        // Three.js geometrik sabitleri
        const BASE_THICKNESS = 0.05; 
        let WORKING_PLANE_HEIGHT = TABLE_FRAME_HEIGHT - BASE_THICKNESS; 
        const BASE_Y = 0; 
        const WORKING_PLANE_Y = BASE_Y + BASE_THICKNESS + 0.01; 
        const MAX_NEON_HEIGHT = 0.40; 

        const NEON_RADIUS = 0.008; 
        const glassThickness = 0.02; 


        // --- Firebase ve Auth İşlemleri ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /** Modalı gösterir */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-container').classList.remove('hidden');
        }

        /** Firebase'i başlatır ve kullanıcıyı oturum açar (Sadece data yüklemek için kullanılır) */
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Using anonymous setup.");
                document.getElementById('user-id-display').textContent = 'Anonim (Kaydetme Devre Dışı)';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); 

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Auth durumu belirlendikten sonra UID'yi ayarla ve veriyi yükle
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId.substring(0, 6) + '...';
                    } else {
                        userId = crypto.randomUUID();
                        document.getElementById('user-id-display').textContent = `Anonim ID: ${userId.substring(0, 6)}...`;
                    }
                    loadUserDesign(); // Sahne kurulduktan sonra veriyi yükle
                });

            } catch (error) {
                console.error("Firebase başlatma hatası:", error);
                showModal("Hata", "Firebase başlatılamadı. Tasarım kaydetme çalışmayabilir.");
            }
        }

        // --- Three.js Sahne ve Nesne Oluşturma ---

        function initThreeJS() {
            // Boyutları güncelle
            const currentSize = tableSizes[currentSizeIndex];
            TABLE_WIDTH = currentSize.width;
            TABLE_DEPTH = currentSize.depth;
            TABLE_FRAME_HEIGHT = currentSize.height;
            WORKING_PLANE_HEIGHT = TABLE_FRAME_HEIGHT - BASE_THICKNESS;
            
            // Yükleme ekranını gizle ve sahneyi başlat
            document.getElementById('loading-overlay').classList.add('hidden');
            const container = document.getElementById('scene-container');
            
            if (scene) {
                const oldCanvas = renderer?.domElement;
                if (oldCanvas) {
                    container.removeChild(oldCanvas);
                }
            }

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111); 

            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(TABLE_WIDTH * 2, TABLE_FRAME_HEIGHT * 2, TABLE_DEPTH * 2); 

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            container.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.minDistance = 1;
            controls.maxDistance = 5;
            controls.target.set(0, TABLE_FRAME_HEIGHT / 2, 0); 
            controls.update();

            scene.add(new THREE.AmbientLight(0x404040, 5)); 
            
            createTable();
            
            // UI elemanlarını sadece bir kez kur
            if (!document.getElementById('size-selector').children.length) {
                setupUI();
            }
            
            animate();

            window.removeEventListener('resize', onWindowResize); 
            window.addEventListener('resize', onWindowResize, false);

            renderer.domElement.removeEventListener('click', onCanvasClick); 
            renderer.domElement.addEventListener('click', onCanvasClick, false);
        }

        function onWindowResize() {
            const container = document.getElementById('scene-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        function createTable() {
            // Önceki masayı temizle
            const oldTable = scene.getObjectByName('Neon_Table_Group');
            if (oldTable) scene.remove(oldTable);
            const oldNeon = scene.getObjectByName('NeonContainer');
            if (oldNeon) scene.remove(oldNeon);
            
            const tableGroup = new THREE.Group();
            tableGroup.name = "Neon_Table_Group";

            // 1. Masa Alt Tabanı (Koyu, Metalik)
            const baseGeometry = new THREE.BoxGeometry(TABLE_WIDTH + 0.05, BASE_THICKNESS, TABLE_DEPTH + 0.05);
            const baseMaterial = new THREE.MeshStandardMaterial({
                color: 0x0A0A0A, 
                metalness: 0.1,
                roughness: 0.8, 
            });
            const baseMesh = new THREE.Mesh(baseGeometry, baseMaterial);
            baseMesh.position.y = BASE_Y + BASE_THICKNESS / 2;
            tableGroup.add(baseMesh);

            // 2. Neon Çalışma Alanı (Ultra Parlak Siyah/Ayna)
            const innerBaseGeometry = new THREE.BoxGeometry(TABLE_WIDTH, 0.005, TABLE_DEPTH);
            const innerBaseMaterial = new THREE.MeshStandardMaterial({
                color: 0x000000,
                metalness: 0.95,
                roughness: 0.0, 
            });
            const innerBaseMesh = new THREE.Mesh(innerBaseGeometry, innerBaseMaterial);
            innerBaseMesh.position.y = WORKING_PLANE_Y; 
            innerBaseMesh.userData.isWorkingPlane = true;
            tableGroup.add(innerBaseMesh);

            // 3. Füme Buzlu Cam Malzemesi
            smokedGlassMirrorMaterial = new THREE.MeshPhysicalMaterial({
                color: 0x222222, 
                metalness: 0.8, 
                roughness: 0.1, 
                opacity: 0.1, 
                transparent: true,
                transmission: 0.0, 
                reflectivity: 0.95, 
                clearcoat: 1.0,
                clearcoatRoughness: 0.1,
                side: THREE.DoubleSide 
            });

            // 4. Cam Çerçeve/Kapak Grubu
            glassContainer = new THREE.Group();
            glassContainer.name = 'GlassContainer';
            const wallHeight = WORKING_PLANE_HEIGHT;
            const center_Y = BASE_THICKNESS + wallHeight / 2;
            
            // Cam Pozisyonları
            glassContainer.userData.closedPosition = new THREE.Vector3(0, BASE_THICKNESS, 0); 
            glassContainer.userData.openPosition = new THREE.Vector3(TABLE_WIDTH * 1.5, BASE_THICKNESS, 0);

            // Yan Duvarlar
            const sides = [
                new THREE.Mesh(new THREE.BoxGeometry(TABLE_WIDTH, wallHeight, glassThickness), smokedGlassMirrorMaterial),
                new THREE.Mesh(new THREE.BoxGeometry(TABLE_WIDTH, wallHeight, glassThickness), smokedGlassMirrorMaterial),
                new THREE.Mesh(new THREE.BoxGeometry(glassThickness, wallHeight, TABLE_DEPTH + 2 * glassThickness), smokedGlassMirrorMaterial),
                new THREE.Mesh(new THREE.BoxGeometry(glassThickness, wallHeight, TABLE_DEPTH + 2 * glassThickness), smokedGlassMirrorMaterial)
            ];

            sides[0].position.set(0, center_Y - BASE_THICKNESS, TABLE_DEPTH / 2 + glassThickness / 2);
            sides[1].position.set(0, center_Y - BASE_THICKNESS, -TABLE_DEPTH / 2 - glassThickness / 2);
            sides[2].position.set(TABLE_WIDTH / 2 + glassThickness / 2, center_Y - BASE_THICKNESS, 0);
            sides[3].position.set(-TABLE_WIDTH / 2 - glassThickness / 2, center_Y - BASE_THICKNESS, 0);
            
            sides.forEach(s => glassContainer.add(s));


            // Üst Cam Kapak
            const glassMesh = new THREE.Mesh(new THREE.BoxGeometry(TABLE_WIDTH + 2 * glassThickness, glassThickness, TABLE_DEPTH + 2 * glassThickness), smokedGlassMirrorMaterial);
            
            const capY = WORKING_PLANE_HEIGHT + glassThickness / 2;
            glassMesh.position.y = capY - BASE_THICKNESS; 
            glassMesh.userData.isGlass = true;
            glassMesh.userData.name = 'Glass_Cover';
            glassContainer.add(glassMesh);
            
            glassContainer.position.copy(glassContainer.userData.closedPosition); 
            tableGroup.add(glassContainer);

            scene.add(tableGroup);

            const neonContainer = new THREE.Group();
            neonContainer.name = 'NeonContainer';
            neonContainer.position.y = WORKING_PLANE_Y; 
            scene.add(neonContainer);
        }
        
        function toggleEffect() {
            isEffectOn = !isEffectOn;
            const neonContainer = scene.getObjectByName('NeonContainer');
            const toggleButton = document.getElementById('toggle-effect');

            const newEmissivePower = isEffectOn ? NEON_EMISSIVE_POWER_ON : NEON_EMISSIVE_POWER_OFF;
            const newReflectivity = isEffectOn ? 0.95 : 0.01; 
            
            if (neonContainer) {
                neonContainer.children.forEach(mesh => {
                    if (mesh.userData.isNeon && mesh.material) {
                        mesh.material.emissiveIntensity = newEmissivePower;
                        mesh.material.needsUpdate = true; 
                    }
                });
            }
            
            if (smokedGlassMirrorMaterial) {
                smokedGlassMirrorMaterial.reflectivity = newReflectivity;
                smokedGlassMirrorMaterial.needsUpdate = true;
            }

            if (isEffectOn) {
                toggleButton.textContent = "Efektleri Kapat (Neon Kapalı)";
                toggleButton.classList.remove('bg-gray-700'); // Koyu gri butonu kaldır
                toggleButton.classList.add('bg-gray-700/50', 'hover:bg-gray-600');
            } else {
                toggleButton.textContent = "Efektleri Aç (Neon Açık)";
                toggleButton.classList.remove('bg-gray-700/50', 'hover:bg-gray-600');
                toggleButton.classList.add('bg-gray-700'); 
            }
        }


        function createNeonObject(color, type) {
            const hexColor = new THREE.Color(color);
            const emissivePower = isEffectOn ? NEON_EMISSIVE_POWER_ON : NEON_EMISSIVE_POWER_OFF;
            
            const emissiveMaterial = new THREE.MeshBasicMaterial({
                color: hexColor,
                emissive: hexColor,
                emissiveIntensity: emissivePower,
                side: THREE.DoubleSide
            });

            let geometry;
            let length;

            if (type === 'straight') {
                length = MAX_NEON_HEIGHT; 
                geometry = new THREE.CylinderGeometry(NEON_RADIUS, NEON_RADIUS, length, 16);
            } 
            else if (type === 'zigzag_m') {
                length = MAX_NEON_HEIGHT * 0.9; 
                const width = TABLE_WIDTH * 0.35; 
                
                const points = [
                    new THREE.Vector3(-width / 2, -length / 2, 0), 
                    new THREE.Vector3(-width / 4, length / 2, 0),             
                    new THREE.Vector3(0, -length / 2 + 0.05, 0), 
                    new THREE.Vector3(width / 4, length / 2, 0),
                    new THREE.Vector3(width / 2, -length / 2, 0) 
                ];

                const customCurve = new THREE.CatmullRomCurve3(points);
                customCurve.curveType = 'chordal'; 
                geometry = new THREE.TubeGeometry(customCurve, 64, NEON_RADIUS, 8, false); 
            }
            else if (type === 'zigzag_n') {
                length = MAX_NEON_HEIGHT * 0.9; 
                const width = TABLE_WIDTH * 0.35;

                const points = [
                    new THREE.Vector3(-width / 2, -length / 2, 0), 
                    new THREE.Vector3(-width / 2, length / 2, 0),             
                    new THREE.Vector3(width / 2, -length / 2 + 0.05, 0), 
                    new THREE.Vector3(width / 2, length / 2, 0)
                ];

                const customCurve = new THREE.CatmullRomCurve3(points);
                customCurve.curveType = 'chordal'; 
                geometry = new THREE.TubeGeometry(customCurve, 64, NEON_RADIUS, 8, false); 
            }
            else if (type === 'v_shape') {
                length = MAX_NEON_HEIGHT * 0.7;
                const width = TABLE_WIDTH * 0.3;

                const points = [
                    new THREE.Vector3(-width / 2, length / 2, 0), 
                    new THREE.Vector3(0, -length / 2 + 0.05, 0), 
                    new THREE.Vector3(width / 2, length / 2, 0) 
                ];

                const customCurve = new THREE.CatmullRomCurve3(points);
                customCurve.curveType = 'chordal'; 
                geometry = new THREE.TubeGeometry(customCurve, 32, NEON_RADIUS, 8, false); 
            }
            else if (type === 'single_peak') {
                length = MAX_NEON_HEIGHT * 0.9;
                const width = TABLE_WIDTH * 0.3;

                const points = [
                    new THREE.Vector3(-width / 2, -length / 2, 0), 
                    new THREE.Vector3(0, length / 2, 0), 
                    new THREE.Vector3(width / 2, -length / 2, 0)
                ];

                const customCurve = new THREE.CatmullRomCurve3(points);
                customCurve.curveType = 'chordal'; 
                geometry = new THREE.TubeGeometry(customCurve, 32, NEON_RADIUS, 8, false); 
            }
            else {
                return null;
            }

            const neonMesh = new THREE.Mesh(geometry, emissiveMaterial);
            neonMesh.userData.isNeon = true;
            neonMesh.userData.color = color;
            neonMesh.userData.type = type;
            neonMesh.userData.length = length;
            neonMesh.userData.id = THREE.MathUtils.generateUUID();
            
            const halfWidth = TABLE_WIDTH / 2 - NEON_RADIUS;
            const halfDepth = TABLE_DEPTH / 2 - NEON_RADIUS;

            neonMesh.position.set(
                THREE.MathUtils.clamp((Math.random() - 0.5) * TABLE_WIDTH * 0.5, -halfWidth, halfWidth),
                length / 2, 
                THREE.MathUtils.clamp((Math.random() - 0.5) * TABLE_DEPTH * 0.5, -halfDepth, halfDepth)
            );
            neonMesh.rotation.y = Math.random() * Math.PI * 2; 

            neonElementsData.push({
                id: neonMesh.userData.id,
                color: neonMesh.userData.color,
                type: neonMesh.userData.type,
                position: neonMesh.position.toArray(), 
                rotation: neonMesh.rotation.toArray()
            });

            scene.getObjectByName('NeonContainer').add(neonMesh);
            return neonMesh;
        }

        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();

        function onCanvasClick(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            
            const neonContainer = scene.getObjectByName('NeonContainer');
            if (!neonContainer) return;
            
            const intersects = raycaster.intersectObjects(neonContainer.children, false);

            if (intersects.length > 0) {
                const neonMesh = intersects[0].object;
                if (neonMesh.userData.isNeon) {
                    selectNeon(neonMesh);
                }
            } else {
                selectNeon(null); 
            }
        }
        
        function selectNeon(mesh) {
            // Önceki seçili objeden glow'u kaldır
            if (selectedNeonObject) {
                selectedNeonObject.material.needsUpdate = true;
            }
            
            selectedNeonObject = mesh;
            const infoPanel = document.getElementById('selected-element-info');
            
            if (mesh) {
                // Seçili objeye hafif bir glow ekleyebiliriz (Material'i değiştirmeden)
                // Şimdilik sadece kamerayı odaklayalım ve paneli açalım
                controls.target.copy(mesh.getWorldPosition(new THREE.Vector3()));
                controls.update();
                
                infoPanel.classList.remove('hidden');
                
                const data = neonElementsData.find(d => d.id === mesh.userData.id);
                if (data) {
                    document.getElementById('control-pos-x').value = data.position[0];
                    document.getElementById('control-pos-z').value = data.position[2];
                    const rotationYDeg = (data.rotation[1] * 180 / Math.PI) % 360;
                    document.getElementById('control-rot-y').value = rotationYDeg < 0 ? rotationYDeg + 360 : rotationYDeg;
                    
                    // Seçili objenin rengini de renk seçicide işaretle
                    document.querySelectorAll('.neon-color-button').forEach(btn => btn.classList.remove('selected'));
                    const selectedColorButton = document.querySelector(`.neon-color-button[data-color="${data.color}"]`);
                    if (selectedColorButton) {
                         selectedColorButton.classList.add('selected');
                         currentSelectedColor = data.color;
                    }
                }
            } else {
                infoPanel.classList.add('hidden');
                controls.target.set(0, TABLE_FRAME_HEIGHT / 2, 0);
                controls.update();
                
                // Seçili rengi ilk başta seçilen renge geri çevir (opsiyonel)
                document.querySelectorAll('.neon-color-button').forEach(btn => btn.classList.remove('selected'));
                document.querySelector(`.neon-color-button[data-color="${currentSelectedColor}"]`)?.classList.add('selected');
            }
        }

        function setupUI() {
            // Renk Seçimi UI
            const colorPicker = document.getElementById('color-picker');
            neonColors.forEach(c => {
                const button = document.createElement('button');
                button.className = 'neon-color-button rounded-full transition duration-150 shadow-lg';
                button.style.backgroundColor = c.hex;
                button.title = c.name;
                button.dataset.color = c.hex;
                button.addEventListener('click', () => {
                    currentSelectedColor = c.hex;
                    document.querySelectorAll('.neon-color-button').forEach(btn => btn.classList.remove('selected'));
                    button.classList.add('selected');

                    if (selectedNeonObject) {
                        updateNeonColor(selectedNeonObject, c.hex);
                        saveDesignDebounced();
                    }
                });
                colorPicker.appendChild(button);
                if (c.hex === currentSelectedColor) {
                    button.classList.add('selected');
                }
            });
            
            document.getElementById('toggle-effect').addEventListener('click', toggleEffect);

            // Şekil Kütüphanesi Aç/Kapa
            const toggleShapesButton = document.getElementById('toggle-shapes');
            const shapeLibrary = document.getElementById('shape-library');
            const shapesArrow = document.getElementById('shapes-arrow');

            toggleShapesButton.addEventListener('click', () => {
                const isHidden = shapeLibrary.classList.toggle('hidden');
                shapesArrow.classList.toggle('rotate-180', !isHidden);
            });
            
            // Şekil Kütüphanesi Ekleme Butonları
            document.getElementById('add-straight-line').addEventListener('click', () => {
                const neon = createNeonObject(currentSelectedColor, 'straight');
                selectNeon(neon);
                saveDesignDebounced();
            });
            document.getElementById('add-zigzag-m-line').addEventListener('click', () => {
                const neon = createNeonObject(currentSelectedColor, 'zigzag_m');
                selectNeon(neon);
                saveDesignDebounced();
            });
            document.getElementById('add-zigzag-n-line').addEventListener('click', () => {
                const neon = createNeonObject(currentSelectedColor, 'zigzag_n');
                selectNeon(neon);
                saveDesignDebounced();
            });
            document.getElementById('add-v-shape-line').addEventListener('click', () => {
                const neon = createNeonObject(currentSelectedColor, 'v_shape');
                selectNeon(neon);
                saveDesignDebounced();
            });
            document.getElementById('add-single-peak-line').addEventListener('click', () => {
                const neon = createNeonObject(currentSelectedColor, 'single_peak');
                selectNeon(neon);
                saveDesignDebounced();
            });

            // Seçili Neon Kontrolleri
            document.getElementById('control-pos-x').addEventListener('input', (e) => {
                if (selectedNeonObject) {
                    selectedNeonObject.position.x = parseFloat(e.target.value);
                    updateNeonData(selectedNeonObject);
                    saveDesignDebounced();
                }
            });
            
            document.getElementById('control-pos-z').addEventListener('input', (e) => {
                if (selectedNeonObject) {
                    selectedNeonObject.position.z = parseFloat(e.target.value);
                    updateNeonData(selectedNeonObject);
                    saveDesignDebounced();
                }
            });
            
            document.getElementById('control-rot-y').addEventListener('input', (e) => {
                if (selectedNeonObject) {
                    selectedNeonObject.rotation.y = parseFloat(e.target.value) * Math.PI / 180;
                    updateNeonData(selectedNeonObject);
                    saveDesignDebounced();
                }
            });
            
            document.getElementById('remove-neon').addEventListener('click', () => {
                if (selectedNeonObject) {
                    removeNeonObject(selectedNeonObject);
                    selectNeon(null);
                    saveDesignDebounced();
                }
            });
            document.getElementById('modal-close').addEventListener('click', () => {
                document.getElementById('modal-container').classList.add('hidden');
            });
            
            // Boyut Seçimi UI
            const sizeSelector = document.getElementById('size-selector');
            const currentPriceDisplayFinal = document.getElementById('current-price-final'); // WP üstündeki final fiyat
            const limitsInfo = document.getElementById('design-limits-info');
            
            function updateSizeDisplay() {
                const currentSize = tableSizes[currentSizeIndex];
                const priceFormatted = currentSize.price.toLocaleString('tr-TR') + ' TL';

                // Fiyatı güncelle
                currentPriceDisplayFinal.textContent = priceFormatted;
                
                // Sınırları güncelle (Yeni, ayrılmış format)
                limitsInfo.innerHTML = `
                    <p class="text-sm font-semibold text-white mb-1">Neon ve Yazı Sınırları:</p>
                    <ul class="list-disc ml-4 space-y-1">
                        <li>M: ${currentSize.limits.m}, A: ${currentSize.limits.a}, V: ${currentSize.limits.v}, N: ${currentSize.limits.n} (Toplam şekil sınırı)</li>
                        <li class="text-yellow-400">Veya Yazı Ekleme: Yaklaşık ${currentSize.limits.text_cm} alan kullanılabilir (Yazı seçilirse şekil eklenemez).</li>
                    </ul>
                `;
            }

            tableSizes.forEach((size, index) => {
                const button = document.createElement('button');
                button.textContent = size.name;
                // Tailwind sınıfları doğrudan butonun kendisine eklendi (CSS'de tanımlı)
                button.className = 'size-button'; 
                button.dataset.index = index;
                
                if (index === currentSizeIndex) {
                    button.classList.add('selected');
                }

                button.addEventListener('click', () => {
                    if (currentSizeIndex === index) return;
                    
                    // Önce tüm butonların seçimini kaldır
                    document.querySelectorAll('.size-button').forEach(btn => btn.classList.remove('selected'));
                    // Seçili butona sınıfı ekle
                    button.classList.add('selected');

                    currentSizeIndex = index;
                    
                    const neonContainer = scene.getObjectByName('NeonContainer');
                    if (neonContainer) {
                        neonContainer.children.slice().forEach(child => {
                            if (child.userData.isNeon) {
                                child.geometry.dispose();
                                child.material.dispose();
                                neonContainer.remove(child);
                            }
                        });
                    }
                    neonElementsData = []; 
                    
                    updateSizeDisplay();
                    
                    initThreeJS(); 
                    showModal("Ebat Güncellemesi", `${size.name} ebatına geçildi. Tasarımınız sıfırlandı. Lütfen yeni ebatta tekrar tasarlayın.`);
                });

                sizeSelector.appendChild(button);
            });
            
            updateSizeDisplay();

            // Cam Aç/Kapa butonu
            document.getElementById('toggle-glass').addEventListener('click', () => {
                if (!glassContainer) return; 

                const closedPos = glassContainer.userData.closedPosition;
                const openPos = new THREE.Vector3(TABLE_WIDTH * 1.5, BASE_THICKNESS, 0);
                
                const isClosed = glassContainer.position.distanceTo(closedPos) < 0.01;
                const toggleButton = document.getElementById('toggle-glass');

                if (isClosed) { 
                    glassContainer.position.copy(openPos); 
                    toggleButton.textContent = "Cam Kapağını Kapat";
                } else { 
                    glassContainer.position.copy(closedPos); 
                    toggleButton.textContent = "Cam Kapağını Kaldır";
                }
            });


            // WhatsApp Sipariş Butonu
            document.getElementById('order-whatsapp').addEventListener('click', () => {
                const currentSize = tableSizes[currentSizeIndex];
                const selectedSize = currentSize.name;
                const totalPrice = currentSize.price;
                
                const designDetails = JSON.stringify(neonElementsData.map(d => ({
                    type: d.type,
                    color: d.color,
                    position_x: d.position[0].toFixed(2),
                    position_z: d.position[2].toFixed(2),
                    rotation_y: (d.rotation[1] * 180 / Math.PI).toFixed(0) + ' derece'
                })), null, 2);
                
                const message = `Merhaba, Neon Masa Tasarımım ile ilgili sipariş vermek istiyorum.

* **Seçilen Ebat:** ${selectedSize}
* **Ebat Fiyatı (KDV Dahil):** ${totalPrice.toLocaleString('tr-TR')} TL
* **Tasarım Detayları:**
${designDetails}

Lütfen en kısa zamanda benimle iletişime geçin. (Tasarım ID: ${userId})`;

                const phoneNumber = '905551234567'; 
                
                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            });
        }
        
        function updateNeonData(mesh) {
            if (!mesh.userData.isNeon) return;

            const halfWidth = TABLE_WIDTH / 2 - NEON_RADIUS;
            const halfDepth = TABLE_DEPTH / 2 - NEON_RADIUS;
            
            mesh.position.x = THREE.MathUtils.clamp(mesh.position.x, -halfWidth, halfWidth);
            mesh.position.z = THREE.MathUtils.clamp(mesh.position.z, -halfDepth, halfDepth);
            
             const data = neonElementsData.find(d => d.id === mesh.userData.id);
             if (data) {
                data.position = mesh.position.toArray();
                data.rotation = mesh.rotation.toArray();
             }
        }

        function updateNeonColor(mesh, color) {
            if (!mesh || !mesh.material) {
                console.error("updateNeonColor: Mesh veya materyal tanımsız. Renk güncellenemedi.");
                return;
            }
            
            const hexColor = new THREE.Color(color);
            mesh.material.color.set(hexColor);
            mesh.material.emissive.set(hexColor);
            
            mesh.material.emissiveIntensity = isEffectOn ? NEON_EMISSIVE_POWER_ON : NEON_EMISSIVE_POWER_OFF;
            mesh.userData.color = color;

             const data = neonElementsData.find(d => d.id === mesh.userData.id);
             if (data) {
                data.color = color;
             }
        }

        function removeNeonObject(mesh) {
            const neonContainer = scene.getObjectByName('NeonContainer');
            if (neonContainer) {
                neonContainer.remove(mesh);
            }
            neonElementsData = neonElementsData.filter(d => d.id !== mesh.userData.id);
            mesh.geometry.dispose();
            mesh.material.dispose();
        }

        const designDocRef = () => {
            return doc(
                db,
                'artifacts',
                appId,
                'users',
                userId,
                'designs', 
                'neon_table_design' 
            );
        };

        const DEBOUNCE_DELAY = 1000; 
        let saveTimeout = null;

        function saveDesignDebounced() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveUserDesign();
            }, DEBOUNCE_DELAY);
        }

        async function saveUserDesign() {
            if (!db || !userId || userId === 'anon_user') {
                console.warn("Kullanıcı kimliği veya Firebase hazır değil. Kaydetme işlemi iptal edildi.");
                return;
            }
            
            const savePayload = {
                version: 2, 
                lastUpdated: Date.now(),
                selectedSizeIndex: currentSizeIndex, 
                neonElements: JSON.stringify(neonElementsData) 
            };

            try {
                await setDoc(designDocRef(), savePayload);
                console.log("Tasarım başarıyla kaydedildi!");
            } catch (error) {
                console.error("Tasarım kaydetme hatası:", error);
                showModal("Kaydetme Hatası", "Tasarım kaydedilirken bir sorun oluştu.");
            }
        }

        async function loadUserDesign() {
            if (!db || !userId) {
                 console.warn("Kullanıcı kimliği veya Firebase hazır değil. Yükleme iptal edildi.");
                return;
            }
            
            const loadButton = document.getElementById('load-design');
            loadButton.textContent = 'Yükleniyor...';
            loadButton.disabled = true;

            try {
                const docSnap = await getDoc(designDocRef());

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    const loadedSizeIndex = data.selectedSizeIndex !== undefined ? data.selectedSizeIndex : 1;
                    
                    if (loadedSizeIndex !== currentSizeIndex) {
                        currentSizeIndex = loadedSizeIndex;
                        
                        // Önce tüm butonların seçimini kaldır
                        document.querySelectorAll('.size-button').forEach(btn => btn.classList.remove('selected'));
                        
                        const selectedSizeButton = document.querySelector(`#size-selector button[data-index="${currentSizeIndex}"]`);
                        if(selectedSizeButton) selectedSizeButton.classList.add('selected');
                        
                        const currentSize = tableSizes[currentSizeIndex];
                        TABLE_WIDTH = currentSize.width;
                        TABLE_DEPTH = currentSize.depth;
                        TABLE_FRAME_HEIGHT = currentSize.height;
                        WORKING_PLANE_HEIGHT = TABLE_FRAME_HEIGHT - BASE_THICKNESS;
                        
                        const neonContainer = scene.getObjectByName('NeonContainer');
                        if (neonContainer) {
                            neonContainer.children.slice().forEach(child => {
                                if (child.userData.isNeon) {
                                    child.geometry.dispose();
                                    child.material.dispose();
                                    neonContainer.remove(child);
                                }
                            });
                        }
                        
                        camera.position.set(TABLE_WIDTH * 2, TABLE_FRAME_HEIGHT * 2, TABLE_DEPTH * 2);
                        controls.target.set(0, TABLE_FRAME_HEIGHT / 2, 0); 
                        controls.update();

                        createTable(); 
                        
                        // Fiyat ve sınırları güncelle
                        document.getElementById('current-price-final').textContent = `${currentSize.price.toLocaleString('tr-TR')} TL`;
                         updateSizeDisplay(); // Sınırları güncellemek için çağırıldı
                    }


                    if (data.neonElements) {
                        const loadedData = JSON.parse(data.neonElements);
                        
                        const neonContainer = scene.getObjectByName('NeonContainer');
                        if (neonContainer) {
                            neonContainer.children.forEach(child => {
                                if (child.userData.isNeon) {
                                    child.geometry.dispose();
                                    child.material.dispose();
                                    neonContainer.remove(child);
                                }
                            });
                        }
                        neonElementsData = [];

                        loadedData.forEach(data => {
                            const mesh = createNeonObject(data.color, data.type);
                            mesh.position.fromArray(data.position);
                            mesh.rotation.fromArray(data.rotation);
                            updateNeonData(mesh); 
                        });

                        showModal("Yükleme Başarılı", `Kaydedilmiş ${loadedData.length} adet neon öğesi yüklendi.`);
                    }
                } else {
                    console.log("Kayıtlı bir tasarım bulunamadı.");
                    showModal("Bilgi", "Kayıtlı bir tasarım bulunamadı. Yeni bir tasarımla başlayın.");
                }
            } catch (error) {
                console.error("Tasarım yükleme hatası:", error);
                showModal("Yükleme Hatası", "Tasarım yüklenirken bir sorun oluştu.");
            } finally {
                loadButton.textContent = 'Yükle';
                loadButton.disabled = false;
            }
        }

        // Uygulamanın başlatılması için yeni ana fonksiyon
        function startApplication() {
            // 1. Sahneyi ve UI'ı hemen başlat (Yüklenme ekranını kapatır)
            initThreeJS();

            // 2. Firebase'i başlat ve veriyi yükle (UI yüklendikten sonra)
            initializeFirebase();
        }

        window.onload = startApplication;
    </script>
</body>
</html>
